/**************************************************/
/*                                                */
/*   iResEditor.js                                */
/*                                      v1.00     */
/*                                                */
/*   Copyright 2016 Takeshi Okamoto (Japan)       */
/*                                                */
/*   Released under the MIT license               */
/*   http://www.petitmonte.com/labo/iResEditor/   */
/*                                                */
/*                            Date: 2016-07-15    */
/**************************************************/
function PE_Byte2String(e){for(var t="",r=0;r<e.length;r++)0!==e[r]&&(t+=String.fromCharCode(e[r]));return t}function PE_Byte2StringN(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function PE_Byte2Word(e){return e[1]<<8|e[0]}function PE_Byte2DWord(e){return(e[3]<<24|e[2]<<16|e[1]<<8|e[0])>>>0}function PE_Byte2QWord(e){return(e[7]<<56|e[6]<<48|e[5]<<40|e[4]<<32|e[3]<<24|e[2]<<16|e[1]<<8|e[0])>>>0}function PE_IntToHex(e,t){for(var r=e.toString(16).toUpperCase(),a=r.length,i=a;t>i;i++)r="0"+r;return"0x"+r}function PE_PaddingDword(e){for(var t=4*Math.floor((e.getFileSize()+3)/4),r=e.getFileSize();t>r;r++)e.WriteByte(0)}function PE_getStringZero(e,t){var r,a="";if(1===t)for(;;){if(e.Pos>=e.FileSize)throw"[PE_getStringZero]:Reached the end of the file.";if(r=e.Read(1)[0],0===r)break;a+=String.fromCharCode(r)}else if(2===t)for(;;){if(e.Pos>=e.FileSize)throw"[PE_getStringZero]:Reached the end of the file.";if(r=PE_Byte2Word(e.Read(2)),0===r)break;a+=String.fromCharCode(r)}return a}function PE_setStringZero(e,t){for(var r=0;r<t.length;r++)e.WriteWord(t.charCodeAt(r));e.WriteWord(0)}function PE_EscapeSequence(e){return e.replace(/"/g,'""').replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")}function PE_ConvertCanUseChar(e,t){return(e+"").replace(/(\\|\/|\?|\:|\*|"|>|<|\|)/g,t)}function PE_ConvertArray(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t}function PE_resTypeIsBinary(e){if("string"==typeof e)return"XML"===e.toUpperCase()?!1:"XSD"===e.toUpperCase()?!1:"XSDFILE"===e.toUpperCase()?!1:"XSLFILE"===e.toUpperCase()?!1:"REGISTRY"===e.toUpperCase()?!1:"LIBRARY"===e.toUpperCase()?!1:"RT_RIBBON_XML"!==e.toUpperCase();switch(e){case 1:return!0;case 2:return!0;case 3:return!0;case 4:return!0;case 5:return!0;case 6:return!0;case 7:return!0;case 8:return!0;case 9:return!0;case 10:return!0;case 11:return!0;case 12:return!0;case 14:return!0;case 16:return!0;case 17:return!0;case 19:return!0;case 20:return!0;case 21:return!0;case 22:return!0;case 23:return!1;case 24:return!1;case 28:return!1;case 241:return!0}return!0}function TReadStream(e){this.Pos=0,this.Stream=e,this.FileSize=e.length}function TFileStream(e){void 0==e?this.MemorySize=5e6:this.MemorySize=parseInt(e,10),this.Size=0,this.Stream=new Uint8Array(this.MemorySize)}function TResEncode(){}function TStringRCEncode(){}function TMessageRCEncode(){}function TDialogRCEncode(){}function TMenuRCEncode(){}function TStringResDecode(){}function TMessageResDecode(){}function TDialogResDecode(){}function TMenuResDecode(){}function TIconResDecode(){}function TCursorResDecode(){}function TBitmapResDecode(){}function TStringResEncode(){}function TDialogResEncode(){}function TMenuResEncode(){}function TPEAnalyst(){}function TResEditor(e){this.FileName=e}TReadStream.prototype={Read:function(e){var t=this.Stream.subarray(this.Pos,this.Pos+e);return this.Pos=this.Pos+e,t},ReadString:function(e){var t=String.fromCharCode.apply(null,this.Stream.subarray(this.Pos,this.Pos+e));return this.Pos=this.Pos+e,t}},TFileStream.prototype={_AsciiToUint8Array:function(e){for(var t=e.length,r=new Uint8Array(t),a=0;t>a;a++)r[a]=255&e[a].charCodeAt(0);return r},WriteByte:function(e){var t=new Uint8Array(1);t[0]=e,this.WriteStream(t)},WriteWord:function(e){var t=new Uint8Array(2);t[1]=(65280&e)>>8,t[0]=255&e,this.WriteStream(t)},WriteDWord:function(e){var t=new Uint8Array(4);t[3]=(4278190080&e)>>24,t[2]=(16711680&e)>>16,t[1]=(65280&e)>>8,t[0]=255&e,this.WriteStream(t)},WriteQWord:function(e){var t=new Uint8Array(8);t[7]=(0xff00000000000000&e)>>56,t[6]=(0xff000000000000&e)>>48,t[5]=(0xff0000000000&e)>>40,t[4]=(0xff00000000&e)>>32,t[3]=(4278190080&e)>>24,t[2]=(16711680&e)>>16,t[1]=(65280&e)>>8,t[0]=255&e,this.WriteStream(t)},WriteString:function(e){var t=this._AsciiToUint8Array(e);if(this.Stream.length<=this.Size+t.length){var r=new Uint8Array(this.Stream);this.Stream=new Uint8Array(this.Size+t.length+this.MemorySize),this.Stream.set(r.subarray(0,r.length))}this.Stream.set(t,this.Size),this.Size=this.Size+t.length},WriteStream:function(e){if(this.Stream.length<=this.Size+e.length){var t=new Uint8Array(this.Stream);this.Stream=new Uint8Array(this.Size+e.length+this.MemorySize),this.Stream.set(t.subarray(0,t.length))}this.Stream.set(e,this.Size),this.Size=this.Size+e.length},getFileSize:function(){return this.Size},SaveToFile:function(e,t){if(window.navigator.msSaveBlob)window.navigator.msSaveBlob(new Blob([this.Stream.subarray(0,this.Size)],{type:t}),e);else{var r=document.createElement("a");r.href=URL.createObjectURL(new Blob([this.Stream.subarray(0,this.Size)],{type:t})),r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r)}}},TResEncode.prototype={SaveToStream:function(e,t,r){var a=new TFileStream(1e5);if(a.WriteDWord(0),a.WriteDWord(32),a.WriteDWord(65535),a.WriteDWord(65535),a.WriteDWord(0),a.WriteDWord(0),a.WriteDWord(0),a.WriteDWord(0),a.WriteDWord(r.length),a.WriteDWord(0),"string"==typeof e)if("RT_RIBBON_XML"===e)a.WriteWord(65535),a.WriteWord(28);else{for(var i=0;i<e.length;i++)a.WriteWord(e.charCodeAt(i));a.WriteWord(0)}else a.WriteWord(65535),a.WriteWord(e);if("string"==typeof t){for(var i=0;i<t.length;i++)a.WriteWord(t.charCodeAt(i));a.WriteWord(0)}else a.WriteWord(65535),a.WriteWord(t);var o=0,s=a.getFileSize();s%4!==0&&(o=4*Math.floor((s+4)/4)-s,o/=2);for(var i=0;o>i;i++)a.WriteWord(0);a.WriteDWord(0),a.WriteWord(0),a.WriteWord(1024),a.WriteDWord(0),a.WriteDWord(0);var n=a.getFileSize()-32;return a.Stream[36]=255&n,a.Stream[37]=(65280&n)>>8,a.Stream[38]=(16711680&n)>>16,a.Stream[39]=(4278190080&n)>>24,a.WriteStream(r),a.Stream.subarray(0,a.getFileSize())},SaveToFile:function(e,t,r,a){var i=new TFileStream(1e5);i.WriteStream(this.SaveToStream(t,r,a)),i.SaveToFile(e)}},TStringRCEncode.prototype={SaveToStream:function(e){var t="STRINGTABLE\r\n";t+="{\r\n";for(var r=0;r<e.ID.length;r++)""!==e.Value[r]&&(t+=e.ID[r]+',  "'+PE_EscapeSequence(e.Value[r])+'"\r\n');t+="}\r\n";var a=new TFileStream(5e4);a.WriteWord(65279);for(var r=0;r<t.length;r++)a.WriteWord(t.charCodeAt(r));return a.Stream.subarray(0,a.getFileSize())},SaveToFile:function(e,t){var r=new TFileStream(5e4);r.WriteStream(this.SaveToStream(t)),r.SaveToFile(e)}},TMessageRCEncode.prototype={SaveToStream:function(e,t){var r=e+" MESSAGETABLE\r\n";r+="{\r\n";for(var a=0;a<t.Message_Resource_Block.length;a++)for(var i=t.Message_Resource_Block[a].LowId,o=0;o<t.Message_Resource_Block[a].Message_Resource_Entry.length;o++){var s=t.Message_Resource_Block[a].Message_Resource_Entry[o].Text;r+="0x"+i.toString(16).toUpperCase()+',  "'+PE_EscapeSequence(s)+'"\r\n',i++}r+="}\r\n";var n=new TFileStream(5e4);n.WriteWord(65279);for(var a=0;a<r.length;a++)n.WriteWord(r.charCodeAt(a));return n.Stream.subarray(0,n.getFileSize())},SaveToFile:function(e,t,r){var a=new TFileStream(5e4);a.WriteStream(this.SaveToStream(t,r)),a.SaveToFile(e)}},TDialogRCEncode.prototype={_getWindowClass:function(e){var t={BUTTON:128,EDIT:129,STATIC:130,LISTBOX:131,SCROLLBAR:132,COMBOBOX:133};if("string"==typeof e)return'"'+e+'"';for(var r in t)if(e===t[r])return r;return e},SaveToStream:function(e,t){var r=e+" ";if(t.DlgTemplate){r+="DIALOG ",r+=t.DlgTemplate.x+","+t.DlgTemplate.y+","+t.DlgTemplate.cx+","+t.DlgTemplate.cy+"\r\n",r+="STYLE 0x"+t.DlgTemplate.style.toString(16).toUpperCase()+"\r\n",0!==t.DlgTemplate.dwExtendedStyle&&(r+="EXSTYLE 0x"+t.DlgTemplate.dwExtendedStyle.toString(16).toUpperCase()+"\r\n"),r+="string"==typeof t.DlgTemplate.title?'CAPTION "'+PE_EscapeSequence(t.DlgTemplate.title)+'"\r\n':'CAPTION ""\r\n',0!==t.DlgTemplate.menu&&(r+="string"==typeof t.DlgTemplate.menu?'MENU "'+PE_EscapeSequence(t.DlgTemplate.menu)+'"\r\n':'MENU "'+t.DlgTemplate.menu.toString(16).toUpperCase()+'"\r\n'),t.DlgTemplate.typeface&&(r+="FONT "+t.DlgTemplate.pointsize+',"'+t.DlgTemplate.typeface+'"\r\n'),r+="{\r\n";for(var a=0;a<t.DlgTemplate.cdit;a++)r+="  CONTROL ",r+="string"==typeof t.DlgItemTemplate[a].title?'"'+PE_EscapeSequence(t.DlgItemTemplate[a].title)+'",':0===t.DlgItemTemplate[a].title?'"",':t.DlgItemTemplate[a].title+",",r+=65535===t.DlgItemTemplate[a].id?"-1,":t.DlgItemTemplate[a].id+",",r+=this._getWindowClass(t.DlgItemTemplate[a].windowClass)+",",r+="0x"+t.DlgItemTemplate[a].style.toString(16).toUpperCase()+",",r+=t.DlgItemTemplate[a].x+","+t.DlgItemTemplate[a].y+","+t.DlgItemTemplate[a].cx+","+t.DlgItemTemplate[a].cy+"\r\n";r+="}\r\n"}else{r+="DIALOGEX ",r+=t.DlgTemplateEx.x+","+t.DlgTemplateEx.y+","+t.DlgTemplateEx.cx+","+t.DlgTemplateEx.cy+"\r\n",r+="STYLE 0x"+t.DlgTemplateEx.style.toString(16).toUpperCase()+"\r\n",0!==t.DlgTemplateEx.exStyle&&(r+="EXSTYLE 0x"+t.DlgTemplateEx.exStyle.toString(16).toUpperCase()+"\r\n"),r+="string"==typeof t.DlgTemplateEx.title?'CAPTION "'+PE_EscapeSequence(t.DlgTemplateEx.title)+'"\r\n':'CAPTION ""\r\n',0!==t.DlgTemplateEx.menu&&(r+="string"==typeof t.DlgTemplateEx.menu?'MENU "'+PE_EscapeSequence(t.DlgTemplateEx.menu)+'"\r\n':'MENU "'+t.DlgTemplateEx.menu.toString(16).toUpperCase()+'"\r\n'),t.DlgTemplateEx.typeface&&(r+="FONT "+t.DlgTemplateEx.pointsize+',"'+t.DlgTemplateEx.typeface+'",'+t.DlgTemplateEx.weight+","+t.DlgTemplateEx.italic+","+t.DlgTemplateEx.charset+"\r\n"),r+="{\r\n";for(var a=0;a<t.DlgTemplateEx.cDlgItems;a++)r+="  CONTROL ",r+="string"==typeof t.DlgItemTemplateEx[a].title?'"'+PE_EscapeSequence(t.DlgItemTemplateEx[a].title)+'",':0===t.DlgItemTemplateEx[a].title?'"",':t.DlgItemTemplateEx[a].title+",",r+=65535===t.DlgItemTemplateEx[a].id?"-1,":t.DlgItemTemplateEx[a].id+",",r+=this._getWindowClass(t.DlgItemTemplateEx[a].windowClass)+",",r+="0x"+t.DlgItemTemplateEx[a].style.toString(16).toUpperCase()+",",r+=t.DlgItemTemplateEx[a].x+","+t.DlgItemTemplateEx[a].y+","+t.DlgItemTemplateEx[a].cx+","+t.DlgItemTemplateEx[a].cy+"\r\n";r+="}\r\n"}var i=new TFileStream(5e4);i.WriteWord(65279);for(var a=0;a<r.length;a++)i.WriteWord(r.charCodeAt(a));return i.Stream.subarray(0,i.getFileSize())},SaveToFile:function(e,t,r){var a=new TFileStream(5e4);a.WriteStream(this.SaveToStream(t,r)),a.SaveToFile(e)}},TMenuRCEncode.prototype={_space:function(e){for(var t="",r=0;e>r;r++)t+=" ";return t},SaveToStream:function(e,t){var r=16,a=128,i=1,o=128,s=e+" ";if(t.MenuHeader){s+="MENU\r\n",s+="{\r\n";for(var n=-1,E=0,m=0;m<t.Items.length;m++)(t.Items[m].menuFlg&r)!==r?(s+=this._space(2*(t.Items[m].level+1)),"-"===t.Items[m].menuText?s+="MENUITEM SEPARATOR\r\n":(s+='MENUITEM "'+PE_EscapeSequence(t.Items[m].menuText)+'",',s+=t.Items[m].menuID,1===(1&t.Items[m].menuFlg)&&(s+=",GRAYED"),2===(2&t.Items[m].menuFlg)&&(s+=",INACTIVE"),4===(4&t.Items[m].menuFlg)&&(s+=",BITMAP"),8===(8&t.Items[m].menuFlg)&&(s+=",CHECKED"),32===(32&t.Items[m].menuFlg)&&(s+=",MENUBARBREAK"),64===(64&t.Items[m].menuFlg)&&(s+=",MENUBREAK"),256===(256&t.Items[m].menuFlg)&&(s+=",OWNERDRAW"),s+="\r\n"),(t.Items[m].menuFlg&a)===a&&0!==E&&(s+=this._space(2*t.Items[m].level),s+="}\r\n",E--),n=t.Items[m].level):(s+=this._space(2*(t.Items[m].level+1)),s+='POPUP "'+PE_EscapeSequence(t.Items[m].menuText)+'"\r\n',s+=this._space(2*(t.Items[m].level+1)),s+="{\r\n",E++,n=t.Items[m].level);for(var m=0;E>m;m++)s+=this._space(2*(n-1)),s+="}\r\n",n--;s+="}\r\n"}else{s+="MENUEX\r\n",s+="{\r\n";for(var n=-1,E=0,m=0;m<t.Items.length;m++)(t.Items[m].menuFlg&i)!==i?(s+=this._space(2*(t.Items[m].level+1)),s+="-"===t.Items[m].menuText?'MENUITEM "",':'MENUITEM "'+PE_EscapeSequence(t.Items[m].menuText)+'",',s+=t.Items[m].menuID+",",s+=t.Items[m].dwType+",",s+=t.Items[m].dwState,s+="\r\n",(t.Items[m].menuFlg&o)===o&&0!==E&&(s+=this._space(2*t.Items[m].level),s+="}\r\n",E--),n=t.Items[m].level):(s+=this._space(2*(t.Items[m].level+1)),s+="-"===t.Items[m].menuText?'POPUP "",':'POPUP "'+PE_EscapeSequence(t.Items[m].menuText)+'",',s+=t.Items[m].menuID+",",s+=t.Items[m].dwType+",",s+=t.Items[m].dwState+",",s+=t.Items[m].dwHelpId+"\r\n",s+=this._space(2*(t.Items[m].level+1)),s+="{\r\n",E++,n=t.Items[m].level);for(var m=0;E>m;m++)s+=this._space(2*(n-1)),s+="}\r\n",n--;s+="}\r\n"}var d=new TFileStream(5e4);d.WriteWord(65279);for(var m=0;m<s.length;m++)d.WriteWord(s.charCodeAt(m));return d.Stream.subarray(0,d.getFileSize())},SaveToFile:function(e,t,r){var a=new TFileStream(5e4);a.WriteStream(this.SaveToStream(t,r)),a.SaveToFile(e)}},TStringResDecode.prototype={LoadFromStream:function(e,t){var r={ID:new Array,Value:new Array};this.Stream=new TReadStream(e);for(var a=0;;){if(this.Stream.Pos>this.Stream.FileSize)throw"[TStringResDecode]:Reached the end of the file.";var i=PE_Byte2Word(this.Stream.Read(2));if(0!==i){for(var o="",s=0;i>s;s++)o+=String.fromCharCode(PE_Byte2Word(this.Stream.Read(2)));if(r.ID[r.ID.length]=(t-1<<4)+a,r.Value[r.Value.length]=o,a++,this.Stream.Pos===this.Stream.FileSize)break}else if(r.ID[r.ID.length]=(t-1<<4)+a,r.Value[r.Value.length]="",a++,this.Stream.Pos===this.Stream.FileSize)break}return r}},TMessageResDecode.prototype={LoadFromStream:function(e){this.Stream=new TReadStream(e);for(var t={NumberOfBlocks:PE_Byte2DWord(this.Stream.Read(4)),Message_Resource_Block:new Array},r=0;r<t.NumberOfBlocks;r++)t.Message_Resource_Block[r]={LowId:PE_Byte2DWord(this.Stream.Read(4)),HighId:PE_Byte2DWord(this.Stream.Read(4)),OffsetToEntries:PE_Byte2DWord(this.Stream.Read(4))},t.Message_Resource_Block[r].Message_Resource_Entry=new Array;for(var r=0;r<t.NumberOfBlocks;r++){this.Stream.Pos=t.Message_Resource_Block[r].OffsetToEntries;for(var a=t.Message_Resource_Block[r].HighId-t.Message_Resource_Block[r].LowId+1,i=0;a>i;i++){t.Message_Resource_Block[r].Message_Resource_Entry[i]={Length:PE_Byte2Word(this.Stream.Read(2)),Flags:PE_Byte2Word(this.Stream.Read(2))};var o;o=1===t.Message_Resource_Block[r].Message_Resource_Entry[i].Flags?PE_getStringZero(this.Stream,2):PE_getStringZero(this.Stream,1),this.Stream.Pos%4!==0&&(this.Stream.Pos=4*Math.floor((this.Stream.Pos+4)/4)),t.Message_Resource_Block[r].Message_Resource_Entry[i].Text=o}}return t}},TDialogResDecode.prototype={getSZorOrdinal:function(e){var t=PE_Byte2Word(e.Read(2));return 0===t?0:65535===t?PE_Byte2Word(e.Read(2)):(e.Pos=e.Pos-2,PE_getStringZero(e,2))},LoadFromStream:function(e){var t=64;this.Stream=new TReadStream(e);var r=PE_Byte2DWord(this.Stream.Read(4));if(4294901761===r){var a={dlgVer:1,signature:65535,helpID:PE_Byte2DWord(this.Stream.Read(4)),exStyle:PE_Byte2DWord(this.Stream.Read(4)),style:PE_Byte2DWord(this.Stream.Read(4)),cDlgItems:PE_Byte2Word(this.Stream.Read(2)),x:PE_Byte2Word(this.Stream.Read(2)),y:PE_Byte2Word(this.Stream.Read(2)),cx:PE_Byte2Word(this.Stream.Read(2)),cy:PE_Byte2Word(this.Stream.Read(2)),menu:this.getSZorOrdinal(this.Stream),windowClass:this.getSZorOrdinal(this.Stream),title:PE_getStringZero(this.Stream,2)};(a.style&t)===t&&(a.pointsize=PE_Byte2Word(this.Stream.Read(2)),a.weight=PE_Byte2Word(this.Stream.Read(2)),a.italic=this.Stream.Read(1)[0],a.charset=this.Stream.Read(1)[0],a.typeface=PE_getStringZero(this.Stream,2));for(var i=new Array,o=0;o<a.cDlgItems;o++)this.Stream.Pos%4!==0&&(this.Stream.Pos=4*Math.floor((this.Stream.Pos+4)/4)),i[o]={helpID:PE_Byte2DWord(this.Stream.Read(4)),exStyle:PE_Byte2DWord(this.Stream.Read(4)),style:PE_Byte2DWord(this.Stream.Read(4)),x:PE_Byte2Word(this.Stream.Read(2)),y:PE_Byte2Word(this.Stream.Read(2)),cx:PE_Byte2Word(this.Stream.Read(2)),cy:PE_Byte2Word(this.Stream.Read(2)),id:PE_Byte2DWord(this.Stream.Read(4)),windowClass:this.getSZorOrdinal(this.Stream),title:this.getSZorOrdinal(this.Stream),extraCount:PE_Byte2Word(this.Stream.Read(2)),lParamData:new Array},0!==i[o].extraCount&&(i[o].lParamData=this.Stream.Read(i[o].extraCount));return{DlgTemplateEx:a,DlgItemTemplateEx:i}}this.Stream.Pos=this.Stream.Pos-4;var s={style:PE_Byte2DWord(this.Stream.Read(4)),dwExtendedStyle:PE_Byte2DWord(this.Stream.Read(4)),cdit:PE_Byte2Word(this.Stream.Read(2)),x:PE_Byte2Word(this.Stream.Read(2)),y:PE_Byte2Word(this.Stream.Read(2)),cx:PE_Byte2Word(this.Stream.Read(2)),cy:PE_Byte2Word(this.Stream.Read(2)),menu:this.getSZorOrdinal(this.Stream),windowClass:this.getSZorOrdinal(this.Stream),title:PE_getStringZero(this.Stream,2)};(s.style&t)===t&&(s.pointsize=PE_Byte2Word(this.Stream.Read(2)),s.typeface=PE_getStringZero(this.Stream,2));for(var n=new Array,o=0;o<s.cdit;o++)this.Stream.Pos%4!==0&&(this.Stream.Pos=4*Math.floor((this.Stream.Pos+4)/4)),n[o]={style:PE_Byte2DWord(this.Stream.Read(4)),dwExtendedStyle:PE_Byte2DWord(this.Stream.Read(4)),x:PE_Byte2Word(this.Stream.Read(2)),y:PE_Byte2Word(this.Stream.Read(2)),cx:PE_Byte2Word(this.Stream.Read(2)),cy:PE_Byte2Word(this.Stream.Read(2)),id:PE_Byte2Word(this.Stream.Read(2)),windowClass:this.getSZorOrdinal(this.Stream),title:this.getSZorOrdinal(this.Stream),extraCount:PE_Byte2Word(this.Stream.Read(2)),lParamData:new Array},0!==n[o].extraCount&&(n[o].lParamData=this.Stream.Read(n[o].extraCount-2));return{DlgTemplate:s,DlgItemTemplate:n}}},TMenuResDecode.prototype={LoadFromStream:function(e){var t=16,r=128,a=1,i=128;this.Stream=new TReadStream(e);var o=PE_Byte2Word(this.Stream.Read(2));if(1===o){for(var s={wVersion:o,wOffset:PE_Byte2Word(this.Stream.Read(2)),dwHelpId:PE_Byte2DWord(this.Stream.Read(4))},n=0,E=new Array;;){if(this.Stream.Pos>=this.Stream.FileSize)throw"[TMenuResDecode]:Reached the end of the file.";var m={dwType:PE_Byte2DWord(this.Stream.Read(4)),dwState:PE_Byte2DWord(this.Stream.Read(4)),menuID:PE_Byte2DWord(this.Stream.Read(4)),menuFlg:PE_Byte2Word(this.Stream.Read(2)),menuText:PE_getStringZero(this.Stream,2)};if(""===m.menuText&&(m.menuText="-"),this.Stream.Pos%4!==0&&(this.Stream.Pos=4*Math.floor((this.Stream.Pos+4)/4)),1===(1&m.menuFlg)&&(m.dwHelpId=PE_Byte2DWord(this.Stream.Read(4))),m.level=n,E[E.length]=m,(m.menuFlg&a)===a&&n++,(m.menuFlg&i)===i&&(m.menuFlg&a)!==a&&n--,(m.menuFlg&r)===r&&this.Stream.Pos===this.Stream.FileSize)break}return{Menuex_Template_Header:s,Items:E}}if(0===o){for(var d,h,l={wVersion:o,cbHeaderSize:PE_Byte2Word(this.Stream.Read(2))},n=0,E=new Array;;){if(this.Stream.Pos>=this.Stream.FileSize)throw"[TMenuResDecode]:Reached the end of the file.";if(d=PE_Byte2Word(this.Stream.Read(2)),h=(d&t)===t?null:PE_Byte2Word(this.Stream.Read(2)),E[E.length]={menuFlg:d,menuID:h,level:n},0===PE_Byte2Word(this.Stream.Read(2))?E[E.length-1].menuText="-":(this.Stream.Pos=this.Stream.Pos-2,E[E.length-1].menuText=PE_getStringZero(this.Stream,2)),(d&t)===t&&n++,(d&r)===r&&(d&t)!==t&&n--,(d&r)===r&&(this.Stream.Pos===this.Stream.FileSize||this.Stream.Pos+2===this.Stream.FileSize))break}return{MenuHeader:l,Items:E}}throw"[TMenuResDecode]:Not menu resource."}},TIconResDecode.prototype={SaveToStream:function(e){this.Stream=new TReadStream(e);var t=new TFileStream(5e4),r=this.Stream.Read(8);if(137==r[0]&&80==r[1]&&78==r[2]&&71==r[3]&&13==r[4]&&10==r[5]&&26==r[6]&&10==r[7])return{Type:"PNG",Stream:e};this.Stream.Pos=0;var a=new Object;a.biSize=PE_Byte2DWord(this.Stream.Read(4)),a.biWidth=PE_Byte2DWord(this.Stream.Read(4)),a.biHeight=PE_Byte2DWord(this.Stream.Read(4)),a.biPlanes=PE_Byte2Word(this.Stream.Read(2)),a.biBitCount=PE_Byte2Word(this.Stream.Read(2)),a.biCompression=PE_Byte2DWord(this.Stream.Read(4)),a.biSizeImage=PE_Byte2DWord(this.Stream.Read(4)),a.biXPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),a.biYPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),a.biClrUsed=PE_Byte2DWord(this.Stream.Read(4)),a.biClrImportant=PE_Byte2DWord(this.Stream.Read(4)),a.biHeight=a.biHeight/2,t.WriteWord(0),t.WriteWord(1),t.WriteWord(1);var i=4*Math.floor((a.biBitCount*a.biWidth+31)/32)*Math.abs(a.biHeight),o=4*Math.floor((1*a.biWidth+31)/32)*Math.abs(a.biHeight),s=0;return 1===a.biBitCount?s=8:4===a.biBitCount?s=64:8===a.biBitCount&&(s=1024),256===a.biWidth?t.WriteByte(0):t.WriteByte(a.biWidth),256===Math.abs(a.biHeight)?t.WriteByte(0):t.WriteByte(a.biHeight),1===a.biBitCount?t.WriteByte(2):4===a.biBitCount?t.WriteByte(16):t.WriteByte(0),t.WriteByte(0),t.WriteWord(1),t.WriteWord(a.biBitCount),t.WriteDWord(s+i+o+40),t.WriteDWord(t.getFileSize()+4),t.WriteStream(e),{Type:"ICO",Stream:t.Stream.subarray(0,t.getFileSize())}}},TCursorResDecode.prototype={SaveToStream:function(e){this.Stream=new TReadStream(e);var t=new TFileStream(5e4),r=PE_Byte2Word(this.Stream.Read(2)),a=PE_Byte2Word(this.Stream.Read(2)),i=this.Stream.Read(8);if(137==i[0]&&80==i[1]&&78==i[2]&&71==i[3]&&13==i[4]&&10==i[5]&&26==i[6]&&10==i[7])return{Type:"PNG",Stream:e.subarray(4,e.length),X:r,Y:a};this.Stream.Pos=this.Stream.Pos-8;var o=new Object;o.biSize=PE_Byte2DWord(this.Stream.Read(4)),o.biWidth=PE_Byte2DWord(this.Stream.Read(4)),o.biHeight=PE_Byte2DWord(this.Stream.Read(4)),o.biPlanes=PE_Byte2Word(this.Stream.Read(2)),o.biBitCount=PE_Byte2Word(this.Stream.Read(2)),o.biCompression=PE_Byte2DWord(this.Stream.Read(4)),o.biSizeImage=PE_Byte2DWord(this.Stream.Read(4)),o.biXPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),o.biYPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),o.biClrUsed=PE_Byte2DWord(this.Stream.Read(4)),o.biClrImportant=PE_Byte2DWord(this.Stream.Read(4)),o.biHeight=o.biHeight/2,t.WriteWord(0),t.WriteWord(2),t.WriteWord(1);var s=4*Math.floor((o.biBitCount*o.biWidth+31)/32)*Math.abs(o.biHeight),n=4*Math.floor((1*o.biWidth+31)/32)*Math.abs(o.biHeight),E=0;return 1===o.biBitCount?E=8:4===o.biBitCount?E=64:8===o.biBitCount&&(E=1024),256===o.biWidth?t.WriteByte(0):t.WriteByte(o.biWidth),256===Math.abs(o.biHeight)?t.WriteByte(0):t.WriteByte(o.biHeight),1===o.biBitCount?t.WriteByte(2):4===o.biBitCount?t.WriteByte(16):t.WriteByte(0),t.WriteByte(0),t.WriteWord(r),t.WriteWord(a),t.WriteDWord(E+s+n+40),t.WriteDWord(t.getFileSize()+4),t.WriteStream(e.subarray(4,e.length)),{Type:"CUR",Stream:t.Stream.subarray(0,t.getFileSize())}}},TBitmapResDecode.prototype={SaveToStream:function(e){this.Stream=new TReadStream(e);var t=new TFileStream(5e4),r=new Object;r.biSize=PE_Byte2DWord(this.Stream.Read(4)),r.biWidth=PE_Byte2DWord(this.Stream.Read(4)),r.biHeight=PE_Byte2DWord(this.Stream.Read(4)),r.biPlanes=PE_Byte2Word(this.Stream.Read(2)),r.biBitCount=PE_Byte2Word(this.Stream.Read(2)),r.biCompression=PE_Byte2DWord(this.Stream.Read(4)),r.biSizeImage=PE_Byte2DWord(this.Stream.Read(4)),r.biXPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),r.biYPelsPerMeter=PE_Byte2DWord(this.Stream.Read(4)),r.biClrUsed=PE_Byte2DWord(this.Stream.Read(4)),r.biClrImportant=PE_Byte2DWord(this.Stream.Read(4)),r.biHeight=r.biHeight/2;var a=4*Math.floor((r.biBitCount*r.biWidth+31)/32)*Math.abs(r.biHeight),i=0;return 24!==r.biBitCount&&32!==r.biBitCount&&(i=4*Math.pow(2,r.biBitCount)),t.WriteByte(66),t.WriteByte(77),t.WriteDWord(54+i+a),t.WriteWord(0),t.WriteWord(0),t.WriteDWord(54+i),t.WriteStream(e),t.Stream.subarray(0,t.getFileSize())}},TStringResEncode.prototype={SaveToStream:function(e){for(var t=new TFileStream(5e3),r=0;r<e.Value.length;r++)if(""===e.Value[r])t.WriteWord(0);else{t.WriteWord(e.Value[r].length);for(var a=0;a<e.Value[r].length;a++)t.WriteWord(e.Value[r].charCodeAt(a))}return t.Stream.subarray(0,t.getFileSize())}},TDialogResEncode.prototype={setSZorOrdinal:function(e,t){"string"==typeof t?PE_setStringZero(e,t):0===t?e.WriteWord(t):(e.WriteWord(65535),e.WriteWord(t))},SaveToStream:function(e){var t=64,r=new TFileStream(5e3);if(e.DlgTemplateEx){r.WriteWord(e.DlgTemplateEx.dlgVer),r.WriteWord(e.DlgTemplateEx.signature),r.WriteDWord(e.DlgTemplateEx.helpID),r.WriteDWord(e.DlgTemplateEx.exStyle),r.WriteDWord(e.DlgTemplateEx.style),r.WriteWord(e.DlgTemplateEx.cDlgItems),r.WriteWord(e.DlgTemplateEx.x),r.WriteWord(e.DlgTemplateEx.y),r.WriteWord(e.DlgTemplateEx.cx),r.WriteWord(e.DlgTemplateEx.cy),this.setSZorOrdinal(r,e.DlgTemplateEx.menu),this.setSZorOrdinal(r,e.DlgTemplateEx.windowClass),PE_setStringZero(r,e.DlgTemplateEx.title),(e.DlgTemplateEx.style&t)===t&&(r.WriteWord(e.DlgTemplateEx.pointsize),r.WriteWord(e.DlgTemplateEx.weight),r.WriteByte(e.DlgTemplateEx.italic),r.WriteByte(e.DlgTemplateEx.charset),PE_setStringZero(r,e.DlgTemplateEx.typeface));for(var a=0;a<e.DlgTemplateEx.cDlgItems;a++){PE_PaddingDword(r),r.WriteDWord(e.DlgItemTemplateEx[a].helpID),r.WriteDWord(e.DlgItemTemplateEx[a].exStyle),r.WriteDWord(e.DlgItemTemplateEx[a].style),r.WriteWord(e.DlgItemTemplateEx[a].x),r.WriteWord(e.DlgItemTemplateEx[a].y),r.WriteWord(e.DlgItemTemplateEx[a].cx),r.WriteWord(e.DlgItemTemplateEx[a].cy),r.WriteDWord(e.DlgItemTemplateEx[a].id),this.setSZorOrdinal(r,e.DlgItemTemplateEx[a].windowClass),this.setSZorOrdinal(r,e.DlgItemTemplateEx[a].title),r.WriteWord(e.DlgItemTemplateEx[a].extraCount);for(var i=0;i<e.DlgItemTemplateEx[a].lParamData.length;i++)r.WriteByte(e.DlgItemTemplateEx[a].lParamData[i])}}else{r.WriteDWord(e.DlgTemplate.style),r.WriteDWord(e.DlgTemplate.dwExtendedStyle),r.WriteWord(e.DlgTemplate.cdit),r.WriteWord(e.DlgTemplate.x),r.WriteWord(e.DlgTemplate.y),r.WriteWord(e.DlgTemplate.cx),r.WriteWord(e.DlgTemplate.cy),this.setSZorOrdinal(r,e.DlgTemplate.menu),this.setSZorOrdinal(r,e.DlgTemplate.windowClass),PE_setStringZero(r,e.DlgTemplate.title),(e.DlgTemplate.style&t)===t&&(r.WriteWord(e.DlgTemplate.pointsize),PE_setStringZero(r,e.DlgTemplate.typeface));for(var a=0;a<e.DlgTemplate.cdit;a++){PE_PaddingDword(r),r.WriteDWord(e.DlgItemTemplate[a].style),r.WriteDWord(e.DlgItemTemplate[a].dwExtendedStyle),r.WriteWord(e.DlgItemTemplate[a].x),r.WriteWord(e.DlgItemTemplate[a].y),r.WriteWord(e.DlgItemTemplate[a].cx),r.WriteWord(e.DlgItemTemplate[a].cy),r.WriteWord(e.DlgItemTemplate[a].id),this.setSZorOrdinal(r,e.DlgItemTemplate[a].windowClass),this.setSZorOrdinal(r,e.DlgItemTemplate[a].title),r.WriteWord(e.DlgItemTemplate[a].extraCount);for(var i=0;i<e.DlgItemTemplate[a].lParamData.length;i++)r.WriteByte(e.DlgItemTemplate[a].lParamData[i])}}return r.Stream.subarray(0,r.getFileSize())}},TMenuResEncode.prototype={SaveToStream:function(e){var t=new TFileStream(5e3);if(e.Menuex_Template_Header){t.WriteWord(e.Menuex_Template_Header.wVersion),t.WriteWord(e.Menuex_Template_Header.wOffset),t.WriteDWord(e.Menuex_Template_Header.dwHelpId);for(var r=0;r<e.Items.length;r++){t.WriteDWord(e.Items[r].dwType),t.WriteDWord(e.Items[r].dwState),t.WriteDWord(e.Items[r].menuID),t.WriteWord(e.Items[r].menuFlg);var a=e.Items[r].menuText;"-"===a&&(a=""),PE_setStringZero(t,a),PE_PaddingDword(t),1===(1&e.Items[r].menuFlg)&&t.WriteDWord(e.Items[r].dwHelpId)}}else{var i=16;t.WriteWord(e.MenuHeader.wVersion),t.WriteWord(e.MenuHeader.cbHeaderSize);for(var r=0;r<e.Items.length;r++)t.WriteWord(e.Items[r].menuFlg),(e.Items[r].menuFlg&i)!==i&&t.WriteWord(e.Items[r].menuID),"-"===e.Items[r].menuText?t.WriteWord(0):PE_setStringZero(t,e.Items[r].menuText);PE_PaddingDword(t)}return t.Stream.subarray(0,t.getFileSize())}},TPEAnalyst.prototype={getTableRVA:function(e,t){return this.IMAGE_OPTIONAL_HEADER.DataDirectory[e].RVA>=this.IMAGE_SECTION_HEADER[t].VirtualAddress?this.IMAGE_OPTIONAL_HEADER.DataDirectory[e].RVA:this.IMAGE_SECTION_HEADER[t].VirtualAddress},getSectionInfo:function(e){for(var t,r=0;r<this.IMAGE_COFF_HEADER.NumberOfSections;r++)if(t=e-this.IMAGE_SECTION_HEADER[r].VirtualAddress,t>=0&&t<this.IMAGE_SECTION_HEADER[r].SizeOfRawData)return{Pos:this.IMAGE_SECTION_HEADER[r].PointerToRawData+t,Size:this.IMAGE_SECTION_HEADER[r].SizeOfRawData-t,Index:r,Name:this.IMAGE_SECTION_HEADER[r].Name};return{Pos:0,Size:0,index:-1,Name:""}},_getCodeSection:function(){var e=new Array;if(0===this.IMAGE_OPTIONAL_HEADER.SizeOfCode)return void(this._CODE_SECTION=e);for(var t,r=0,a=0;a<this.IMAGE_SECTION_HEADER.length;a++)if(this.IMAGE_OPTIONAL_HEADER.BaseOfCode===this.IMAGE_SECTION_HEADER[a].VirtualAddress){if(t=this.IMAGE_SECTION_HEADER[a].VirtualSize>this.IMAGE_SECTION_HEADER[a].SizeOfRawData?0===this.IMAGE_SECTION_HEADER[a].SizeOfRawData?0:this.IMAGE_SECTION_HEADER[a].VirtualSize:this.IMAGE_SECTION_HEADER[a].SizeOfRawData,e[e.length]=this.IMAGE_SECTION_HEADER[a],r+=t,this.IMAGE_OPTIONAL_HEADER.SizeOfCode<=r)return void(this._CODE_SECTION=e);for(var i=a+1;;){if(this.IMAGE_SECTION_HEADER.length<=i)throw"[_getCodeSection]:Could not read properly.";if(t=this.IMAGE_SECTION_HEADER[i].VirtualSize>this.IMAGE_SECTION_HEADER[i].SizeOfRawData?0===this.IMAGE_SECTION_HEADER[i].SizeOfRawData?0:this.IMAGE_SECTION_HEADER[i].VirtualSize:this.IMAGE_SECTION_HEADER[i].SizeOfRawData,e[e.length]=this.IMAGE_SECTION_HEADER[i],r+=t,this.IMAGE_OPTIONAL_HEADER.SizeOfCode<=r)return void(this._CODE_SECTION=e);i++}}this._CODE_SECTION=e},_getDataSection:function(){for(var e=new Array,t=0;t<this.IMAGE_SECTION_HEADER.length;t++)e[e.length]=this.IMAGE_SECTION_HEADER[t];for(var t=0;t<this._CODE_SECTION.length;t++)for(var r=0;r<e.length;r++)e[r].Name===this._CODE_SECTION[t].Name&&e.splice(r,1);for(var a,t=0;t<this.IMAGE_OPTIONAL_HEADER.DataDirectory.length;t++)if(6!==t){a=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[t].RVA);for(var r=0;r<e.length;r++)e[r].Name===a.Name&&e.splice(r,1)}this._DATA_SECTION=e},getExportInfo:function(){if(this.Export={Names:new Array},0!==this.IMAGE_OPTIONAL_HEADER.DataDirectory[0].RVA){var e=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[0].RVA);if(-1!==e.Index){this.Stream.Pos=e.Pos;var t=this.Stream.Read(e.Size),r=new TReadStream(t),a={ExportFlags:PE_Byte2DWord(r.Read(4)),TimeDateStamp:PE_Byte2DWord(r.Read(4)),MajorVersion:PE_Byte2Word(r.Read(2)),MinorVersion:PE_Byte2Word(r.Read(2)),NameRVA:PE_Byte2DWord(r.Read(4)),OrdinalBase:PE_Byte2DWord(r.Read(4)),AddressTableEntries:PE_Byte2DWord(r.Read(4)),NumberofNamePointers:PE_Byte2DWord(r.Read(4)),ExportAddressTableRVA:PE_Byte2DWord(r.Read(4)),NamePointerRVA:PE_Byte2DWord(r.Read(4)),OrdinalTableRVA:PE_Byte2DWord(r.Read(4))};if(0!==a.AddressTableEntries){var i=this.getTableRVA(0,e.Index),o=new Array;r.Pos=a.ExportAddressTableRVA-i;for(var s=0;s<a.AddressTableEntries;s++)o[s]=PE_Byte2DWord(r.Read(4));var n=new Array;r.Pos=a.NamePointerRVA-i;for(var s=0;s<a.NumberofNamePointers;s++)n[s]=PE_Byte2DWord(r.Read(4));var E=new Array;r.Pos=a.OrdinalTableRVA-i;for(var s=0;s<a.NumberofNamePointers;s++)E[s]=PE_Byte2Word(r.Read(2))+a.OrdinalBase;r.Pos=a.NameRVA-i;for(var m,d="";;){if(r.Pos>=r.FileSize)throw"Export:Reached the end of the file.";if(m=PE_Byte2StringN(r.Read(1)),"\x00"===m)break;d+=m}this.Export.Names[0]=d,this.Export[this.Export.Names[0]]={Ordinal:new Array,Hint:new Array,Function:new Array,EntryPoint:o,EntryName:new Array};for(var h=new Array,s=0;s<n.length;s++){r.Pos=n[s]-i;for(var m,d="";;){if(r.Pos>=r.FileSize)throw"Export:Reached the end of the file.";if(m=PE_Byte2StringN(r.Read(1)),"\x00"===m)break;d+=m}h[s]=d}for(var l=new Array,s=0;s<a.AddressTableEntries;s++)this.Export[this.Export.Names[0]].EntryName[s]="",l[s]=s,s>=a.NumberofNamePointers&&(E[s]=-1);for(var S,D=0,_=a.OrdinalBase;;){if(S=!1,-1!==E[s])for(var s=0;s<E.length;s++)if(E[s]===_){this.Export[this.Export.Names[0]].Ordinal[D]=E[s],this.Export[this.Export.Names[0]].Hint[D]=l[s],this.Export[this.Export.Names[0]].Function[D]=h[s],_++,S=!0;break}if(!S){var R=o[D]-i;if(R>0){r.Pos=R;for(var m,d="";;){if(r.Pos>=r.FileSize)throw"Export:Reached the end of the file.";if(m=PE_Byte2StringN(r.Read(1)),"\x00"===m)break;d+=m}this.Export[this.Export.Names[0]].EntryName[D]=d}this.Export[this.Export.Names[0]].Hint[D]="N/A",this.Export[this.Export.Names[0]].Function[D]="N/A",this.Export[this.Export.Names[0]].Ordinal[D]=_,_++}if(D++,D===o.length)break}}}}},getImportInfo:function(){if(this.Import={Names:new Array},0!==this.IMAGE_OPTIONAL_HEADER.DataDirectory[1].RVA){var e=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[1].RVA);if(-1!==e.Index){this.Stream.Pos=e.Pos;for(var t=this.Stream.Read(e.Size),r=new TReadStream(t),a=this.getTableRVA(1,e.Index),i=0,o=new Array;;){if(r.Pos>=r.FileSize)throw"Import:Reached the end of the file.";if(o[i]={ImportLookupTableRVA:PE_Byte2DWord(r.Read(4)),TimeDateStamp:PE_Byte2DWord(r.Read(4)),FowarderChain:PE_Byte2DWord(r.Read(4)),NameRVA:PE_Byte2DWord(r.Read(4)),ImportAddressTableRVA:PE_Byte2DWord(r.Read(4))},0===o[i].TimeDateStamp&&0===o[i].NameRVA)break;i++}for(var s=0;s<o.length-1;s++){r.Pos=o[s].NameRVA-a;for(var n,E="";;){if(r.Pos>=r.FileSize)throw"Import:Reached the end of the file.";if(n=PE_Byte2StringN(r.Read(1)),"\x00"===n)break;E+=n}this.Import.Names[this.Import.Names.length]=E,
this.Import[E]=new Array}for(var s=0;s<o.length-1;s++){0!==o[s].ImportLookupTableRVA?r.Pos=o[s].ImportLookupTableRVA-a:r.Pos=o[s].ImportAddressTableRVA-a;for(var i=0,m=new Array;;){if(r.Pos>=r.FileSize)throw"Import:Reached the end of the file.";if(523===this.IMAGE_OPTIONAL_HEADER.Magic?m[i]=PE_Byte2QWord(r.Read(8)):m[i]=PE_Byte2DWord(r.Read(4)),0===m[i])break;i++}for(var d=0;;){if(d>=m.length-1)break;if(0!==(2147483648&m[d])){var h=this.Import.Names[s];this.Import[h][this.Import[h].length]=m[d]-2147483648+"(Ordinal number)"}else{if(2147483648===m[d+1]){var h=this.Import.Names[s];this.Import[h][this.Import[h].length]=m[d]+"(Ordinal number)",d+=2;continue}var l=m[d]-a;r.Pos=l+2;for(var n,E="";;){if(r.Pos>=r.FileSize)throw"Import:Reached the end of the file.";if(n=PE_Byte2StringN(r.Read(1)),"\x00"===n)break;E+=n}var h=this.Import.Names[s];this.Import[h][this.Import[h].length]=E}d++}}this.Import.Names.sort();for(var s=0;s<this.Import.Names.length;s++)this.Import[this.Import.Names[s]].sort()}}},getResourceInfo:function(){function e(e){switch(e){case 1:return"Cursor";case 2:return"Bitmap";case 3:return"Icon";case 4:return"Menu";case 5:return"Dialog";case 6:return"String Table";case 7:return"Font Directory";case 8:return"Font";case 9:return"Accelerator";case 10:return"RCData";case 11:return"Message Table";case 12:return"Cursor Group";case 14:return"Icon Group";case 16:return"Version Info";case 17:return"Dialog Include";case 19:return"Plug and Play";case 20:return"VXD";case 21:return"Animation Cursor";case 22:return"Animation Icon";case 23:return"HTML";case 24:return"Manifest";case 28:return"Ribbon";case 241:return"ToolBar"}return e}function t(r,a,i,o,s){for(var n={Characteristics:PE_Byte2DWord(r.Read(4)),TimeDateStamp:PE_Byte2DWord(r.Read(4)),MajorVersion:PE_Byte2Word(r.Read(2)),MinorVersion:PE_Byte2Word(r.Read(2)),NumberofNameEntries:PE_Byte2Word(r.Read(2)),NumberofIDEntries:PE_Byte2Word(r.Read(2))},E=new Array,m=0;m<n.NumberofNameEntries;m++){var d=PE_Byte2DWord(r.Read(4)),h=PE_Byte2DWord(r.Read(4));E[m]={IntegerID:d,DataEntryOffset:h,ResourceName:"",ResourceNameFlg:!0,DirectoryFlg:!1,SubDirectoryOffsetFlg:!1}}for(var m=0;m<n.NumberofIDEntries;m++){var d=PE_Byte2DWord(r.Read(4)),h=PE_Byte2DWord(r.Read(4));E[E.length]={IntegerID:d,DataEntryOffset:h,ResourceName:"",ResourceNameFlg:!1,DirectoryFlg:!1,SubDirectoryOffsetFlg:!1}}for(var m=0;m<E.length;m++){if((2147483648&E[m].IntegerID)>>>0===2147483648&&(E[m].DirectoryFlg=!0,E[m].ResourceNameFlg=!0),E[m].IntegerID=(2147483647&E[m].IntegerID)>>>0,(2147483648&E[m].DataEntryOffset)>>>0===2147483648&&(E[m].SubDirectoryOffsetFlg=!0),E[m].DataEntryOffset=(2147483647&E[m].DataEntryOffset)>>>0,E[m].ResourceNameFlg){r.Pos=E[m].IntegerID;for(var l=PE_Byte2Word(r.Read(2)),S="",D=0;l>D;D++)S+=String.fromCharCode(PE_Byte2Word(r.Read(2)));E[m].ResourceName=S}1==i&&(E[m].ResourceNameFlg?E[m].ResourceTypeName=E[m].ResourceName:E[m].ResourceTypeName=e(E[m].IntegerID))}if(1===i){a.Resource={Type:void 0},a.Resource.Type={ResourceDirectoryTables:n},a.Resource.Type.ResourceDirectoryEntries=E,a.Resource.Name=new Array,a.Resource.Language=new Array;for(var m=0;m<E.length;m++)r.Pos=E[m].DataEntryOffset,t(r,a,2,m)}else if(2===i){a.Resource.Name[a.Resource.Name.length]={ResourceDirectoryTables:n,ResourceDirectoryEntries:E};for(var m=0;m<E.length;m++)r.Pos=E[m].DataEntryOffset,E[m].ResourceNameFlg?t(r,a,3,o,E[m].ResourceName):t(r,a,3,o,E[m].IntegerID)}else if(3===i){a.Resource.Language[a.Resource.Language.length]={resNameID:s,parent:o,ResourceDirectoryTables:n,ResourceDirectoryEntries:E,ResourceDataEntry:new Array};for(var m=0;m<E.length;m++){r.Pos=E[m].DataEntryOffset;var _={DataRVA:PE_Byte2DWord(r.Read(4)),Size:PE_Byte2DWord(r.Read(4)),Codepage:PE_Byte2DWord(r.Read(4)),Reserved:PE_Byte2DWord(r.Read(4))},R=a.Resource.Language[a.Resource.Language.length-1].ResourceDataEntry;R[R.length]=_}}}if(0!==this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA){var r=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA);if(-1!==r.Index){this.Stream.Pos=r.Pos;var a=this.Stream.Read(r.Size),i=new TReadStream(a);t(i,this,1)}}},LoadFromStream:function(e,t){if(this.Stream=new TReadStream(e),this.IMAGE_DOS_HEADER={e_magic:PE_Byte2String(this.Stream.Read(2)),e_cblp:PE_Byte2Word(this.Stream.Read(2)),e_cp:PE_Byte2Word(this.Stream.Read(2)),e_crlc:PE_Byte2Word(this.Stream.Read(2)),e_cparhdr:PE_Byte2Word(this.Stream.Read(2)),e_minalloc:PE_Byte2Word(this.Stream.Read(2)),e_maxalloc:PE_Byte2Word(this.Stream.Read(2)),e_ss:PE_Byte2Word(this.Stream.Read(2)),e_sp:PE_Byte2Word(this.Stream.Read(2)),e_csum:PE_Byte2Word(this.Stream.Read(2)),e_ip:PE_Byte2Word(this.Stream.Read(2)),e_cs:PE_Byte2Word(this.Stream.Read(2)),e_lfarlc:PE_Byte2Word(this.Stream.Read(2)),e_ovno:PE_Byte2Word(this.Stream.Read(2)),e_res:this.Stream.Read(8),e_oemid:PE_Byte2Word(this.Stream.Read(2)),e_oeminfo:PE_Byte2Word(this.Stream.Read(2)),e_res2:this.Stream.Read(20),NextOffset:PE_Byte2Word(this.Stream.Read(4))},"MZ"!==this.IMAGE_DOS_HEADER.e_magic)throw"This file is not in the EXE / DLL files.";if(this.Stream.Pos=this.IMAGE_DOS_HEADER.NextOffset,this.IMAGE_COFF_HEADER={Magic:PE_Byte2String(this.Stream.Read(4)),Machine:PE_Byte2Word(this.Stream.Read(2)),NumberOfSections:PE_Byte2Word(this.Stream.Read(2)),TimeDateStamp:PE_Byte2DWord(this.Stream.Read(4)),PointerToSymbolTable:PE_Byte2DWord(this.Stream.Read(4)),NumberOfSymbols:PE_Byte2DWord(this.Stream.Read(4)),SizeOfOptionalHeader:PE_Byte2Word(this.Stream.Read(2)),Characteristics:PE_Byte2Word(this.Stream.Read(2))},"PE"!==this.IMAGE_COFF_HEADER.Magic)throw"16-bit applications can not read.";var r=PE_Byte2Word(this.Stream.Read(2));this.IMAGE_OPTIONAL_HEADER={Magic:r,MajorLinkerVersion:this.Stream.Read(1)[0],MinorLinkerVersion:this.Stream.Read(1)[0],SizeOfCode:PE_Byte2DWord(this.Stream.Read(4)),SizeOfInitializedData:PE_Byte2DWord(this.Stream.Read(4)),SizeOfUninitializedData:PE_Byte2DWord(this.Stream.Read(4)),AddressOfEntryPoint:PE_Byte2DWord(this.Stream.Read(4)),BaseOfCode:PE_Byte2DWord(this.Stream.Read(4))},523!==r&&(this.IMAGE_OPTIONAL_HEADER.BaseOfData=PE_Byte2DWord(this.Stream.Read(4))),523===r?(this.IMAGE_OPTIONAL_HEADER.ImageBase1=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.ImageBase2=PE_Byte2DWord(this.Stream.Read(4))):this.IMAGE_OPTIONAL_HEADER.ImageBase=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SectionAlignment=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.FileAlignment=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.MajorOperatingSystemVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.MinorOperatingSystemVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.MajorImageVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.MinorImageVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.MajorSubsystemVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.MinorSubsystemVersion=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.Win32VersionValue=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfImage=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeaders=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.CheckSum=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.Subsystem=PE_Byte2Word(this.Stream.Read(2)),this.IMAGE_OPTIONAL_HEADER.DllCharacteristics=PE_Byte2Word(this.Stream.Read(2)),523===r?(this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve1=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve2=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit1=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit2=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve1=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve2=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit1=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit2=PE_Byte2DWord(this.Stream.Read(4))):(this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit=PE_Byte2DWord(this.Stream.Read(4))),this.IMAGE_OPTIONAL_HEADER.LoaderFlags=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes=PE_Byte2DWord(this.Stream.Read(4)),this.IMAGE_OPTIONAL_HEADER.DataDirectory=new Array;for(var a=0;a<this.IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes;a++)this.IMAGE_OPTIONAL_HEADER.DataDirectory[a]={RVA:PE_Byte2DWord(this.Stream.Read(4)),Size:PE_Byte2DWord(this.Stream.Read(4))};this.IMAGE_SECTION_HEADER=new Array;for(var a=0;a<this.IMAGE_COFF_HEADER.NumberOfSections;a++)this.IMAGE_SECTION_HEADER[a]={Name:PE_Byte2String(this.Stream.Read(8)),VirtualSize:PE_Byte2DWord(this.Stream.Read(4)),VirtualAddress:PE_Byte2DWord(this.Stream.Read(4)),SizeOfRawData:PE_Byte2DWord(this.Stream.Read(4)),PointerToRawData:PE_Byte2DWord(this.Stream.Read(4)),PointerToRelocations:PE_Byte2DWord(this.Stream.Read(4)),PointerToLinenumbers:PE_Byte2DWord(this.Stream.Read(4)),NumberOfRelocations:PE_Byte2Word(this.Stream.Read(2)),NumberOfLinenumbers:PE_Byte2Word(this.Stream.Read(2)),Characteristics:PE_Byte2DWord(this.Stream.Read(4))};for(var i=0,a=0;a<this.IMAGE_SECTION_HEADER.length;a++)if(0!==this.IMAGE_SECTION_HEADER[a].PointerToRawData){i=this.IMAGE_SECTION_HEADER[a].PointerToRawData;break}if(0===i)throw"This file is broken.";i===this.Stream.Pos?this._COMMENT1=new Array:this._COMMENT1=this.Stream.Read(i-this.Stream.Pos);var o=this.IMAGE_SECTION_HEADER[this.IMAGE_SECTION_HEADER.length-1],s=o.PointerToRawData+o.SizeOfRawData;if(s===this.Stream.FileSize?this._COMMENT2=new Array:(this.Stream.Pos=s,this._COMMENT2=this.Stream.Read(this.Stream.FileSize-s)),t){this.IsPacked=!1,-1!==this.IMAGE_SECTION_HEADER[0].Name.toUpperCase().indexOf("UPX")&&-1!==this.IMAGE_SECTION_HEADER[1].Name.toUpperCase().indexOf("UPX")&&(this.IsPacked=!0),3758096512===this.IMAGE_SECTION_HEADER[0].Characteristics&&3758096448===this.IMAGE_SECTION_HEADER[1].Characteristics&&(this.IsPacked=!0);for(var a=0;a<this.IMAGE_SECTION_HEADER.length;a++)if(-1!==this.IMAGE_SECTION_HEADER[a].Name.toUpperCase().indexOf("ASPACK")){this.IsPacked=!0;break}this.IsPacked||(this.getExportInfo(),this.getImportInfo(),this.getResourceInfo())}else this.getExportInfo(),this.getImportInfo(),this.getResourceInfo();this.Stream.Pos=0},_CompileResourceStream:function(e){function t(e,t,r,a,i,o,s,n){e.WriteDWord(r.Characteristics),e.WriteDWord(r.TimeDateStamp),e.WriteWord(r.MajorVersion),e.WriteWord(r.MinorVersion),e.WriteWord(r.NumberofNameEntries),e.WriteWord(r.NumberofIDEntries);for(var E=r.NumberofNameEntries+r.NumberofIDEntries,m=0;E>m;m++){var d=0;if(a[m].ResourceNameFlg){d=i.Total+n.getFileSize(),n.WriteWord(a[m].ResourceName.length);for(var h=0;h<a[m].ResourceName.length;h++)n.WriteWord(a[m].ResourceName.charCodeAt(h));PE_PaddingDword(n)}else d=a[m].IntegerID;a[m].DirectoryFlg&&(d=(2147483648|d)>>>0),e.WriteDWord(d);var l=0,S=0;if(1===o){l=i.Type;for(var h=0;m>h;h++)S=S+8+8+8*(t.Name[h].ResourceDirectoryTables.NumberofNameEntries+t.Name[h].ResourceDirectoryTables.NumberofIDEntries)}else if(2===o){l=i.Type+i.Name;for(var D=0,h=0;m>h;h++)D++;for(var h=0;s>h;h++)D+=t.Name[h].ResourceDirectoryTables.NumberofNameEntries+t.Name[h].ResourceDirectoryTables.NumberofIDEntries;for(var h=0;D>h;h++)S=S+8+8+8*(t.Language[h].ResourceDirectoryTables.NumberofNameEntries+t.Language[h].ResourceDirectoryTables.NumberofIDEntries)}else if(3===o){l=i.Type+i.Name+i.Lang;for(var _=0,h=0;m>h;h++)_++;for(var h=0;s>h;h++)_+=t.Language[h].ResourceDirectoryTables.NumberofNameEntries+t.Language[h].ResourceDirectoryTables.NumberofIDEntries;for(var h=0;_>h;h++)S+=16}var R=l+S;R=a[m].SubDirectoryOffsetFlg?(2147483648|R)>>>0:R,e.WriteDWord(R)}}var r=new TFileStream,a=new TFileStream,i=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA),o=this.getTableRVA(2,i.Index);this.Stream.Pos=i.Pos;var s=new TReadStream(this.Stream.Read(i.Size)),n={Type:0,Name:0,Lang:0,RDE:0,Total:0};n.Type=16+8*(this.Resource.Type.ResourceDirectoryTables.NumberofNameEntries+this.Resource.Type.ResourceDirectoryTables.NumberofIDEntries);for(var E=0;E<this.Resource.Name.length;E++)n.Name=n.Name+8+8+8*(this.Resource.Name[E].ResourceDirectoryTables.NumberofNameEntries+this.Resource.Name[E].ResourceDirectoryTables.NumberofIDEntries);for(var E=0;E<this.Resource.Language.length;E++)n.Lang=n.Lang+8+8+8*(this.Resource.Language[E].ResourceDirectoryTables.NumberofNameEntries+this.Resource.Language[E].ResourceDirectoryTables.NumberofIDEntries);for(var E=0;E<this.Resource.Language.length;E++)n.RDE=n.RDE+16*this.Resource.Language[E].ResourceDataEntry.length;n.Total=n.Type+n.Name+n.Lang+n.RDE,t(r,this.Resource,this.Resource.Type.ResourceDirectoryTables,this.Resource.Type.ResourceDirectoryEntries,n,1,null,a);for(var E=0;E<this.Resource.Name.length;E++)t(r,this.Resource,this.Resource.Name[E].ResourceDirectoryTables,this.Resource.Name[E].ResourceDirectoryEntries,n,2,E,a);for(var E=0;E<this.Resource.Language.length;E++)t(r,this.Resource,this.Resource.Language[E].ResourceDirectoryTables,this.Resource.Language[E].ResourceDirectoryEntries,n,3,E,a);for(var E=0;E<this.Resource.Language.length;E++)for(var m=this.Resource.Type.ResourceDirectoryEntries[this.Resource.Language[E].parent].IntegerID,d=0;d<this.Resource.Language[E].ResourceDataEntry.length;d++){var h,l,S,D=this.Resource.Language[E].resNameID,_=this.Resource.Language[E].ResourceDirectoryEntries[d].IntegerID;if(4===m&&0!==e.Menu.length){for(var R=0;R<e.Menu.length;R++)if(e.Menu[R].resNameID===D&&e.Menu[R].resLangID===_){var c=new TMenuResEncode;h=c.SaveToStream(e.Menu[R].resObject);break}}else if(5===m&&0!==e.Dialog.length){for(var R=0;R<e.Dialog.length;R++)if(e.Dialog[R].resNameID===D&&e.Dialog[R].resLangID===_){var A=new TDialogResEncode;h=A.SaveToStream(e.Dialog[R].resObject);break}}else if(6===m&&0!==e.String.length){for(var R=0;R<e.String.length;R++)if(e.String[R].resNameID===D&&e.String[R].resLangID===_){var I=new TStringResEncode;h=I.SaveToStream(e.String[R].resObject);break}}else s.Pos=this.Resource.Language[E].ResourceDataEntry[d].DataRVA-o,h=s.Read(this.Resource.Language[E].ResourceDataEntry[d].Size);l=n.Total+a.getFileSize()+o,S=h.length,a.WriteStream(h),PE_PaddingDword(a),r.WriteDWord(l),r.WriteDWord(S),r.WriteDWord(this.Resource.Language[E].ResourceDataEntry[d].Codepage),r.WriteDWord(this.Resource.Language[E].ResourceDataEntry[d].Reserved)}return r.WriteStream(a.Stream.subarray(0,a.getFileSize())),PE_PaddingDword(r),r.Stream.subarray(0,r.getFileSize())},_CompileResourceFile:function(e,t){var r=new TFileStream;r.WriteStream(this._CompileResourceStream(t)),r.SaveToFile(e)},SaveToStream:function(e){var t=new TFileStream;if(!this.Resource)throw"Do not have the resource.";for(var r=this.getSectionInfo(this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA),a=r.Index,i=this._CompileResourceStream(e),o=this.IMAGE_OPTIONAL_HEADER.FileAlignment,s=Math.floor((i.length+(o-1))/o)*o,n=new Uint8Array(s),E=0;E<i.length;E++)n[E]=i[E];for(var E=i.length;s>E;E++)n[E]=0;var m,d,h=n;d=m=i.length;for(var l=h.length-this.IMAGE_SECTION_HEADER[a].SizeOfRawData,S=this.IMAGE_OPTIONAL_HEADER.SizeOfInitializedData+l,D=0,_=this.IMAGE_OPTIONAL_HEADER.SectionAlignment,E=0;E<this.IMAGE_COFF_HEADER.NumberOfSections;E++)D+=E===a?d<=this.IMAGE_SECTION_HEADER[a].VirtualSize?Math.floor((this.IMAGE_SECTION_HEADER[a].VirtualSize+(_-1))/_)*_:Math.floor((d+(_-1))/_)*_:Math.floor((this.IMAGE_SECTION_HEADER[E].VirtualSize+(_-1))/_)*_;D+=this.IMAGE_OPTIONAL_HEADER.BaseOfCode;var R=Math.floor((this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].Size+(_-1))/_)*_,c=Math.floor((m+(_-1))/_)*_,A=this.IMAGE_SECTION_HEADER[a].SizeOfRawData,I=Math.floor((d+(o-1))/o)*o;t.WriteString(this.IMAGE_DOS_HEADER.e_magic),t.WriteWord(this.IMAGE_DOS_HEADER.e_cblp),t.WriteWord(this.IMAGE_DOS_HEADER.e_cp),t.WriteWord(this.IMAGE_DOS_HEADER.e_crlc),t.WriteWord(this.IMAGE_DOS_HEADER.e_cparhdr),t.WriteWord(this.IMAGE_DOS_HEADER.e_minalloc),t.WriteWord(this.IMAGE_DOS_HEADER.e_maxalloc),t.WriteWord(this.IMAGE_DOS_HEADER.e_ss),t.WriteWord(this.IMAGE_DOS_HEADER.e_sp),t.WriteWord(this.IMAGE_DOS_HEADER.e_csum),t.WriteWord(this.IMAGE_DOS_HEADER.e_ip),t.WriteWord(this.IMAGE_DOS_HEADER.e_cs),t.WriteWord(this.IMAGE_DOS_HEADER.e_lfarlc),t.WriteWord(this.IMAGE_DOS_HEADER.e_ovno);for(var E=0;E<this.IMAGE_DOS_HEADER.e_res.length;E++)t.WriteByte(this.IMAGE_DOS_HEADER.e_res[E]);t.WriteWord(this.IMAGE_DOS_HEADER.e_oemid),t.WriteWord(this.IMAGE_DOS_HEADER.e_oeminfo);for(var E=0;E<this.IMAGE_DOS_HEADER.e_res2.length;E++)t.WriteByte(this.IMAGE_DOS_HEADER.e_res2[E]);t.WriteDWord(this.IMAGE_DOS_HEADER.NextOffset),this.Stream.Pos=t.getFileSize(),n=this.Stream.Read(this.IMAGE_DOS_HEADER.NextOffset-this.Stream.Pos),t.WriteStream(n),t.WriteDWord(17744),t.WriteWord(this.IMAGE_COFF_HEADER.Machine),t.WriteWord(this.IMAGE_COFF_HEADER.NumberOfSections),t.WriteDWord(this.IMAGE_COFF_HEADER.TimeDateStamp),t.WriteDWord(this.IMAGE_COFF_HEADER.PointerToSymbolTable),t.WriteDWord(this.IMAGE_COFF_HEADER.NumberOfSymbols),t.WriteWord(this.IMAGE_COFF_HEADER.SizeOfOptionalHeader),t.WriteWord(this.IMAGE_COFF_HEADER.Characteristics),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.Magic),t.WriteByte(this.IMAGE_OPTIONAL_HEADER.MajorLinkerVersion),t.WriteByte(this.IMAGE_OPTIONAL_HEADER.MinorLinkerVersion),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfCode),t.WriteDWord(S),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfUninitializedData),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.AddressOfEntryPoint),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.BaseOfCode),523!==this.IMAGE_OPTIONAL_HEADER.Magic&&t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.BaseOfData),523!==this.IMAGE_OPTIONAL_HEADER.Magic?t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.ImageBase):(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.ImageBase1),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.ImageBase2)),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SectionAlignment),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.FileAlignment),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MajorOperatingSystemVersion),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MinorOperatingSystemVersion),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MajorImageVersion),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MinorImageVersion),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MajorSubsystemVersion),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.MinorSubsystemVersion),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.Win32VersionValue),t.WriteDWord(D),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeaders),t.WriteDWord(0),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.Subsystem),t.WriteWord(this.IMAGE_OPTIONAL_HEADER.DllCharacteristics),523!==this.IMAGE_OPTIONAL_HEADER.Magic?(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit)):(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve1),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackReserve2),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit1),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfStackCommit2),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve1),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapReserve2),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit1),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.SizeOfHeapCommit2)),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.LoaderFlags),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes);for(var E=0;E<this.IMAGE_OPTIONAL_HEADER.NumberOfRvaAndSizes;E++)2===E?(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].RVA),m<=this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].Size?t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].Size):t.WriteDWord(m)):m>this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].Size&&0!==this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].RVA&&this.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA<=this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].RVA?(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].RVA+(I-A)),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].Size)):(t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].RVA),t.WriteDWord(this.IMAGE_OPTIONAL_HEADER.DataDirectory[E].Size));for(var E=0;E<this.IMAGE_COFF_HEADER.NumberOfSections;E++){for(var u=new Uint8Array(8),g=0;8>g;g++)u[g]=0;for(var g=0;g<this.IMAGE_SECTION_HEADER[E].Name.length;g++)u[g]=255&this.IMAGE_SECTION_HEADER[E].Name.charCodeAt(g);t.WriteStream(u),E===a?(d<=this.IMAGE_SECTION_HEADER[a].VirtualSize?t.WriteDWord(this.IMAGE_SECTION_HEADER[a].VirtualSize):t.WriteDWord(d),t.WriteDWord(this.IMAGE_SECTION_HEADER[a].VirtualAddress),t.WriteDWord(I),t.WriteDWord(this.IMAGE_SECTION_HEADER[a].PointerToRawData)):(t.WriteDWord(this.IMAGE_SECTION_HEADER[E].VirtualSize),d>this.IMAGE_SECTION_HEADER[a].VirtualSize&&this.IMAGE_SECTION_HEADER[a].VirtualAddress<=this.IMAGE_SECTION_HEADER[E].VirtualAddress?t.WriteDWord(this.IMAGE_SECTION_HEADER[E].VirtualAddress+(c-R)):t.WriteDWord(this.IMAGE_SECTION_HEADER[E].VirtualAddress),t.WriteDWord(this.IMAGE_SECTION_HEADER[E].SizeOfRawData),this.IMAGE_SECTION_HEADER[a].PointerToRawData<=this.IMAGE_SECTION_HEADER[E].PointerToRawData?t.WriteDWord(this.IMAGE_SECTION_HEADER[E].PointerToRawData+(I-A)):t.WriteDWord(this.IMAGE_SECTION_HEADER[E].PointerToRawData)),t.WriteDWord(this.IMAGE_SECTION_HEADER[E].PointerToRelocations),t.WriteDWord(this.IMAGE_SECTION_HEADER[E].PointerToLinenumbers),t.WriteWord(this.IMAGE_SECTION_HEADER[E].NumberOfRelocations),t.WriteWord(this.IMAGE_SECTION_HEADER[E].NumberOfLinenumbers),t.WriteDWord(this.IMAGE_SECTION_HEADER[E].Characteristics)}0!==this._COMMENT1.length&&t.WriteStream(this._COMMENT1);for(var n,E=0;E<this.IMAGE_COFF_HEADER.NumberOfSections;E++)E===a?t.WriteStream(h):(this.Stream.Pos=this.IMAGE_SECTION_HEADER[E].PointerToRawData,n=this.Stream.Read(this.IMAGE_SECTION_HEADER[E].SizeOfRawData),t.WriteStream(n));return 0!==this._COMMENT2.length&&t.WriteStream(this._COMMENT2),t.Stream.subarray(0,t.getFileSize())},SaveToFile:function(e,t){var r=new TFileStream;r.WriteStream(this.SaveToStream(t)),r.SaveToFile(e)}},TResEditor.prototype={ExtractRCFile:function(e){var t=this.PEAnalyst;if(t.Resource){for(var r=new Zlib.Zip,a=t.Resource.Type,i=t.Resource.Language,o=0;o<a.ResourceDirectoryEntries.length;o++)for(var s=a.ResourceDirectoryEntries[o].ResourceTypeName,n=0;n<i.length;n++)if(i[n].parent===o)for(var E=0;E<i[n].ResourceDataEntry.length;E++){switch(a.ResourceDirectoryEntries[i[n].parent].IntegerID){case 4:break;case 5:break;case 6:break;default:continue}this._BIN.Pos=i[n].ResourceDataEntry[E].DataRVA-this._ResourceRVA;var m,d=this._BIN.Read(i[n].ResourceDataEntry[E].Size);if(4===a.ResourceDirectoryEntries[i[n].parent].IntegerID){var h=new TMenuResDecode,l=h.LoadFromStream(d),S=new TMenuRCEncode;m=S.SaveToStream(i[n].resNameID,l)}if(5===a.ResourceDirectoryEntries[i[n].parent].IntegerID){var D=new TDialogResDecode,l=D.LoadFromStream(d),_=new TDialogRCEncode;m=_.SaveToStream(i[n].resNameID,l)}if(6===a.ResourceDirectoryEntries[i[n].parent].IntegerID){var R=new TStringResDecode,l=R.LoadFromStream(d,i[n].resNameID),c=new TStringRCEncode;m=c.SaveToStream(l)}var A;A=i[n].ResourceDirectoryEntries[E].ResourceNameFlg?i[n].ResourceDirectoryEntries[E].ResourceName:i[n].ResourceDirectoryEntries[E].IntegerID;var I;I=1===i[n].ResourceDataEntry.length?PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"@"+PE_ConvertCanUseChar(A,"_")+".rc":PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"\\"+PE_ConvertCanUseChar(A,"_")+".rc",r.addFile(m,{filename:PE_ConvertArray(I),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var u=r.compress();if(r.files.length>0){var g=new TFileStream;return g.WriteStream(u),g.SaveToFile(e),!0}return!1}return!1},ExtractResFile:function(e){var t=this.PEAnalyst;if(t.Resource){for(var r=new Zlib.Zip,a=t.Resource.Type,i=t.Resource.Language,o=0;o<a.ResourceDirectoryEntries.length;o++)for(var s=a.ResourceDirectoryEntries[o].ResourceTypeName,n=0;n<i.length;n++)if(i[n].parent===o)for(var E=0;E<i[n].ResourceDataEntry.length;E++){var m;if(a.ResourceDirectoryEntries[i[n].parent].ResourceNameFlg){if("RT_RIBBON_XML"!==a.ResourceDirectoryEntries[i[n].parent].ResourceName)continue;m=".res"}else switch(a.ResourceDirectoryEntries[i[n].parent].IntegerID){case 1:m=".cur";break;case 3:m=".ico";break;case 2:case 4:case 5:case 6:case 9:case 10:case 11:case 16:case 23:case 24:case 28:case 241:m=".res";break;default:continue}this._BIN.Pos=i[n].ResourceDataEntry[E].DataRVA-this._ResourceRVA;var d,h=this._BIN.Read(i[n].ResourceDataEntry[E].Size);if(1===a.ResourceDirectoryEntries[i[n].parent].IntegerID){var l=new TCursorResDecode,S=l.SaveToStream(h);d=S.Stream}else if(3===a.ResourceDirectoryEntries[i[n].parent].IntegerID){var D=new TIconResDecode,S=D.SaveToStream(h);d=S.Stream,"PNG"===S.Type&&(m=".png")}else{var _;_=a.ResourceDirectoryEntries[i[n].parent].ResourceNameFlg?a.ResourceDirectoryEntries[i[n].parent].ResourceName:a.ResourceDirectoryEntries[i[n].parent].IntegerID;var _,R;R=i[n].ResourceDirectoryEntries[E].ResourceNameFlg?i[n].ResourceDirectoryEntries[E].ResourceName:i[n].ResourceDirectoryEntries[E].IntegerID;var c=new TResEncode;d=c.SaveToStream(_,i[n].resNameID,h)}var A;A=1===i[n].ResourceDataEntry.length?PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"@"+PE_ConvertCanUseChar(R,"_")+m:PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"\\"+PE_ConvertCanUseChar(R,"_")+m,r.addFile(d,{filename:PE_ConvertArray(A),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var I=r.compress();if(r.files.length>0){var u=new TFileStream;return u.WriteStream(I),u.SaveToFile(e),!0}return!1}return!1},ExtractBinFile:function(e){var t=this.PEAnalyst;if(t.Resource){for(var r=new Zlib.Zip,a=t.Resource.Type,i=t.Resource.Language,o=0;o<a.ResourceDirectoryEntries.length;o++)for(var s=a.ResourceDirectoryEntries[o].ResourceTypeName,n=0;n<i.length;n++)if(i[n].parent===o)for(var E=0;E<i[n].ResourceDataEntry.length;E++){this._BIN.Pos=i[n].ResourceDataEntry[E].DataRVA-this._ResourceRVA;var m,d=this._BIN.Read(i[n].ResourceDataEntry[E].Size);m=i[n].ResourceDirectoryEntries[E].ResourceNameFlg?i[n].ResourceDirectoryEntries[E].ResourceName:i[n].ResourceDirectoryEntries[E].IntegerID;var h;h=1===i[n].ResourceDataEntry.length?PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"@"+PE_ConvertCanUseChar(m,"_")+".bin":PE_ConvertCanUseChar(s,"_")+"\\"+PE_ConvertCanUseChar(i[n].resNameID,"_")+"\\"+PE_ConvertCanUseChar(m,"_")+".bin",r.addFile(d,{filename:PE_ConvertArray(h),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var l=r.compress();if(r.files.length>0){var S=new TFileStream;return S.WriteStream(l),S.SaveToFile(e),!0}return!1}return!1},_SaveCodeSection:function(e){var t=new TFileStream,r=new Zlib.Zip;if(this.PEAnalyst._getCodeSection(),0===this.PEAnalyst._CODE_SECTION.length)return!1;for(var a=0;a<this.PEAnalyst._CODE_SECTION.length;a++){this.PEAnalyst.Stream.Pos=this.PEAnalyst._CODE_SECTION[a].PointerToRawData;var i=this.PEAnalyst.Stream.Read(this.PEAnalyst._CODE_SECTION[a].SizeOfRawData);r.addFile(i,{filename:PE_ConvertArray(this.PEAnalyst._CODE_SECTION[a].Name),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var o=r.compress(),t=new TFileStream;return t.WriteStream(o),t.SaveToFile(e),!0},_SaveDataSection:function(e){var t=new TFileStream,r=new Zlib.Zip;if(this.PEAnalyst._getCodeSection(),this.PEAnalyst._getDataSection(),0===this.PEAnalyst._DATA_SECTION.length)return!1;for(var a=0;a<this.PEAnalyst._DATA_SECTION.length;a++){this.PEAnalyst.Stream.Pos=this.PEAnalyst._DATA_SECTION[a].PointerToRawData;var i=this.PEAnalyst.Stream.Read(this.PEAnalyst._DATA_SECTION[a].SizeOfRawData);r.addFile(i,{filename:PE_ConvertArray(this.PEAnalyst._DATA_SECTION[a].Name),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var o=r.compress(),t=new TFileStream;return t.WriteStream(o),t.SaveToFile(e),!0},_SaveCommnet1:function(e){if(0!==this.PEAnalyst._COMMENT1.length){var t=new TFileStream;return t.WriteStream(this.PEAnalyst._COMMENT1.subarray(0,this.PEAnalyst._COMMENT1.length)),t.SaveToFile(e),!0}return!1},_SaveCommnet2:function(e){if(0!==this.PEAnalyst._COMMENT2.length){var t=new TFileStream;return t.WriteStream(this.PEAnalyst._COMMENT2.subarray(0,this.PEAnalyst._COMMENT2.length)),t.SaveToFile(e),!0}return!1},_SaveResourceBinary:function(e){var t=new TFileStream;return t.WriteStream(this._BIN.Stream.subarray(0,this._BIN.FileSize)),t.SaveToFile(e),!0},_SaveAllSection:function(e){var t=new TFileStream,r=new Zlib.Zip;if(0===this.PEAnalyst.IMAGE_COFF_HEADER.NumberOfSections)return!1;for(var a=0;a<this.PEAnalyst.IMAGE_COFF_HEADER.NumberOfSections;a++){this.PEAnalyst.Stream.Pos=this.PEAnalyst.IMAGE_SECTION_HEADER[a].PointerToRawData;var i=this.PEAnalyst.Stream.Read(this.PEAnalyst.IMAGE_SECTION_HEADER[a].SizeOfRawData);r.addFile(i,{filename:PE_ConvertArray(this.PEAnalyst.IMAGE_SECTION_HEADER[a].Name),compressionMethod:Zlib.Zip.CompressionMethod.STORE})}var o=r.compress(),t=new TFileStream;return t.WriteStream(o),t.SaveToFile(e),!0},SaveExportCSV:function(e){var t=this.PEAnalyst;if(t.Export&&0!==t.Export.Names.length){for(var r="Ordinal,Hint,Function,EntryPoint,EntryName\r\n",a=0;a<t.Export[t.Export.Names[0]].Ordinal.length;a++)r+=t.Export[t.Export.Names[0]].Ordinal[a]+",",r+=t.Export[t.Export.Names[0]].Hint[a]+",",r+=t.Export[t.Export.Names[0]].Function[a]+",",r+=PE_IntToHex(t.Export[t.Export.Names[0]].EntryPoint[a],8)+",",r+=t.Export[t.Export.Names[0]].EntryName[a]+"\r\n";var i=new TFileStream;return i.WriteStream(PE_ConvertArray(r)),"undefined"==typeof e?i.SaveToFile(t.Export.Names[0]+".csv"):i.SaveToFile(e),!0}return!1},SaveImportTEXT:function(e){var t=this.PEAnalyst;if(t.Import&&0!==t.Import.Names.length){for(var r="",a=0,i=0;i<t.Import.Names.length;i++)for(var o=0;o<t.Import[t.Import.Names[i]].length;o++)a++;r+="----------------------------------------------------------------------\r\n",r+="Import DLL "+t.Import.Names.length+" Total API "+a+"\r\n",r+="----------------------------------------------------------------------\r\n";for(var i=0;i<t.Import.Names.length;i++)r+=t.Import.Names[i]+"\r\n";for(var i=0;i<t.Import.Names.length;i++){r+="----------------------------------------------------------------------\r\n",r+="["+t.Import.Names[i]+"]\r\n",r+="----------------------------------------------------------------------\r\n";for(var o=0;o<t.Import[t.Import.Names[i]].length;o++)r+=t.Import[t.Import.Names[i]][o]+"\r\n"}var s=new TFileStream;return s.WriteStream(PE_ConvertArray(r)),s.SaveToFile(e),!0}return!1},LoadFromStream:function(e,t,r){this.PEAnalyst=new TPEAnalyst;try{var a=this.PEAnalyst;if("undefined"==typeof r||r?a.LoadFromStream(e,!0):a.LoadFromStream(e,!1),523===a.IMAGE_OPTIONAL_HEADER.Magic?this.OS="64bit":this.OS="32bit",t&&(this.Edit={Menu:new Array,Dialog:new Array,String:new Array},a.Resource)){var i=a.getSectionInfo(a.IMAGE_OPTIONAL_HEADER.DataDirectory[2].RVA);this._ResourceRVA=a.getTableRVA(2,i.Index),a.Stream.Pos=i.Pos,this._BIN=new TReadStream(a.Stream.Read(i.Size));for(var o=0;o<a.Resource.Language.length;o++){var s=a.Resource.Type.ResourceDirectoryEntries[a.Resource.Language[o].parent].IntegerID;if(4===s||5===s||6===s)for(var n=a.Resource.Language[o].resNameID,E=0;E<a.Resource.Language[o].ResourceDataEntry.length;E++){var m=a.Resource.Language[o].ResourceDirectoryEntries[E].IntegerID;this._BIN.Pos=a.Resource.Language[o].ResourceDataEntry[E].DataRVA-this._ResourceRVA;var d,h=this._BIN.Read(a.Resource.Language[o].ResourceDataEntry[E].Size);if(4===s){var l=new TMenuResDecode;d=l.LoadFromStream(h),this.Edit.Menu[this.Edit.Menu.length]={resNameID:n,resLangID:m,resObject:d}}else if(5===s){var S=new TDialogResDecode;
d=S.LoadFromStream(h),this.Edit.Dialog[this.Edit.Dialog.length]={resNameID:n,resLangID:m,resObject:d}}else if(6===s){var D=new TStringResDecode;d=D.LoadFromStream(h,n),this.Edit.String[this.Edit.String.length]={resNameID:n,resLangID:m,resObject:d}}}}this._BIN.Pos=0,a.Stream.Pos=0}}catch(_){throw _}},SaveToStream:function(){if(!this.Edit)throw"None,Edit property.";try{return this.PEAnalyst.SaveToStream(this.Edit)}catch(e){throw e}},SaveToFile:function(e){if(!this.Edit)throw"None,Edit property.";try{this.PEAnalyst.SaveToFile(e,this.Edit)}catch(t){throw t}}};